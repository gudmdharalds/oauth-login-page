# oauth-login-page

A rather simple login-page written in PHP, intended to authenticate users via OAuth 2.0 server. Standalone, no frameworks. 

# Features
- Provides OAuth 2.0 authentication interface to calling sites. Redirects browsers back to calling site after authentication (Implicit Grant type).
- Communicates with OAuth 2.0 servers to authenticate, using customized grant (Extension Grants type).
- Grabs tokens from OAuth 2.0 server and gives to the authenticated user's browser.
- Only recognized sites will be able to have users authenticate and redirected back.
- Uses sophisticated nonce strings to counteract attempts to steal authentication tokens.
- Standalone, no frameworks required.
- Possible to run the site on multiple hosts simultainously, as all shared data is stored in database.

# Security features
- Implements OAuth 2.0 interface for sites wanting to authenticate against us
- Verification of redirection URIs done by OAuth 2.0 server
- Strict input checking
- Nonce tokens are used to counteract attempts to let users use other forms to submit against oauth-login-page
- Nonce tokens are created, using a static secret key (configurable), a session secret (attached to user's session, autogenerated), a salt and an expiry timestamp. These are then hashed. The nonce string will contain the salt, timestamp and the resulting hash.
- Sessions are initialized after many of PHP's default settings are changed. These settings will decrease the odds of sessions being hijacked.

# TODO
- Implement simple rate-limiting functionality
- Display what scopes are being requested
- Optional Hawk-authentication and verification

# Installing 

## Configuration file

## Configure PHP
- It is recommended to set up XCache/APC to increase speed.
- It is recommended to use database connection pooling, as the code does a lot of fast-run queries, and each request takes a short while.
- Install PHP pecl-runkit add-on (if you want to run the unit tests)
- Optionally set the following variables in /etc/php.ini for increased security:

```ini
max_execution_time = 45
max_input_time = 20
max_input_vars = 75
memory_limit = 50M
post_max_size = 250K
```

## Creating DB-table

```sql
CREATE TABLE `lp_sessions` (
  `session_id` varchar(256) CHARACTER SET latin1 NOT NULL DEFAULT '',
  `session_expires` int(10) unsigned NOT NULL DEFAULT '0',
  `session_data` text,
  PRIMARY KEY (`session_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
```

Note: You should create a similar database, with the suffix '_test', if you wish to run the test suite. 

# OAuth 2.0 servers

You should only use servers that are compliant with RFC6749. It is very important that the OAuth server actually checks that the redirect URIs match the client_id sent. Unrecognized sites should never be able to have authorized users redirected to them.

# Configuring calling site (clients)

Configuring calling sites involves creating records with OAuth 2.0 server. Then to actually perform authentication, one must have users submitting forms such as this one:

```html
        <form action="https://Z.Z.Z.Z/authorize" method="GET"> <!-- Z.Z.Z.Z is path to where this package is deployed -->
        <input type="hidden" name="response_type" value="token"> <!-- type of response; always "token" -->
        <input type="hidden" name="redirect_uri" value="<?php echo urlencode("https://Y.Y.Y.Y/redirect.php"); ?>"> <!-- redirect URI - i.e. URI to the site requesting access -->
        <input type="hidden" name="scope" value="mysite-api"> <!-- requested scope -->
        <input type="hidden" name="client_id" value="testclient"> <!-- client_id -->
        <input type="hidden" name="state" value="39260fcb02ff666f1174ec364950e3c769ea4cc9339526bfd255791f533b1b92"> <!-- unique hash -->

        <input type="submit" value="Log in">
        </form>
```




